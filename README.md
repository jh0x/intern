# intern
Simple Interner for Immutable Strings

## Table of Contents
- [Small Strings](#small-strings)
    - [Tiny Small String](#tiny-small-string)
    - [Small String V1](#small-string-v1)
    - [Small String V2](#small-string-v2)

## Small Strings
### Tiny Small String

- `sizeof(T) == sizeof(char*)`
- `sso_size == sizeof(T) - 1`
- last byte used to store adjusted size (SSO) and a flag indicating whether SSO is being used.
- non-SSO case requires that the far data is at least `alignas(2)` because we use the least significant bit for storing non-SSO flag.
- non-SSO case stores the data pointer in Big Endian notation thus needed a `bswap` on the way in and out.
- trivial to copy
- checking whether `small()` always required

#### Examples:
##### SSO
`░ := storage`, `▓ := sso_size - length`:

```
┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐
│░░░░░░░░││░░░░░░░░││░░░░░░░░││░░░░░░░░││░░░░░░░░││░░░░░░░░││░░░░░░░░││▓▓▓▓▓▓▓0│
└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘

String = 012345, sz = 6, sso_size - sz = 7 - 6 = 1

┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐
│00110000││00110001││00110010││00110011││00110100││00110101││00000000││00000010│
├────────┤├────────┤├────────┤├────────┤├────────┤├────────┤├────────┤├────────┤
│0x30='0'││0x31='1'││0x32='2'││0x33='3'││0x34='4'││0x35='5'││0x0='\0'││(7-6)<<1│
└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘
```

##### Non-SSO
`▒ := data pointer` (stored as Big Endian number):

```
┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐
│▒▒▒▒▒▒▒▒││▒▒▒▒▒▒▒▒││▒▒▒▒▒▒▒▒││▒▒▒▒▒▒▒▒││▒▒▒▒▒▒▒▒││▒▒▒▒▒▒▒▒││▒▒▒▒▒▒▒▒││▒▒▒▒▒▒▒1│
└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘

const char* ptr = 0x000000000040724a (this is natural notation)
                  0x4a72400000000000 (this is little endian representation)

Little Endian representation does not work with our SSO so we need to do a bswap:

   Here we use the "extra storage" due to the string being at least alignas(2)┐
                                                                              │
┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐
│00000000││00000000││00000000││00000000││00000000││01000000││01110010││01001011│
├────────┤├────────┤├────────┤├────────┤├────────┤├────────┤├────────┤├────────┤
│   00   ││   00   ││   00   ││   00   ││   00   ││   40   ││   72   ││   4b   │
└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘
```


### Small String V1

- `sizeof(T) == S`, `S >= 16`, `S % 8 == 0`
- `sso_size == S - 1`
- last byte used to store adjusted size (SSO) and a flag indicating whether SSO is being used.
- non-SSO case stores the data pointer in natural representation. We also store string length locally.
- trivial to copy
- checking whether `small()` always required

#### Examples:
##### SSO
`░ := storage`, `▓ := sso_size - length`:

```
┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐
│░░░░░░░░││░░░░░░░░││░░░░░░░░││░░░░░░░░││░░░░░░░░││░░░░░░░░││░░░░░░░░││░░░░░░░░│
└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘
┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐
│░░░░░░░░││░░░░░░░░││░░░░░░░░││░░░░░░░░││░░░░░░░░││░░░░░░░░││░░░░░░░░││▓▓▓▓▓▓▓0│
└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘

String = 0123456789ABCDE, sz = 15, sso_size - sz = 15 - 15 = 0

┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐
│00110000││00110001││00110010││00110011││00110100││00110101││00110110││00110111│
├────────┤├────────┤├────────┤├────────┤├────────┤├────────┤├────────┤├────────┤
│0x30='0'││0x31='1'││0x32='2'││0x33='3'││0x34='4'││0x35='5'││0x36='6'││0x37='7'│
└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘
┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐
│00111000││00111001││01000001││01000010││01000011││01000100││01000101││00000000│
├────────┤├────────┤├────────┤├────────┤├────────┤├────────┤├────────┤├────────┤
│0x38='8'││0x39='9'││0x41='A'││0x42='B'││0x43='C'││0x44='D'││0x45='E'││(15-15) << 1│
└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘
```

##### Non-SSO
`▒ := data pointer`, `▓ := size` :

```
┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐
│░░░░░░░░││░░░░░░░░││░░░░░░░░││░░░░░░░░││░░░░░░░░││░░░░░░░░││░░░░░░░░││░░░░░░░░│
└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘
┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐
│▓▓▓▓▓▓▓▓││▓▓▓▓▓▓▓▓││▓▓▓▓▓▓▓▓││▓▓▓▓▓▓▓▓││▓▓▓▓▓▓▓▓││▓▓▓▓▓▓▓▓││▓▓▓▓▓▓▓▓││▓▓▓▓▓▓▓▓│
└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘

const char* ptr = 0x000000000040724a, sz = 130 (0x82)

┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐
│01001010││01110010││01000000││00000000││00000000││00000000││00000000││00000000│
├────────┤├────────┤├────────┤├────────┤├────────┤├────────┤├────────┤├────────┤
│   4a   ││   72   ││   40   ││   00   ││   00   ││   00   ││   00   ││   00   │
└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘
┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐┌76543210┐
│10000010││00000000││00000000││00000000││00000000││00000000││00000000││00000001│
├────────┤├────────┤├────────┤├────────┤├────────┤├────────┤├────────┤├───────╫┤
│   82   ││   00   ││   00   ││   00   ││   00   ││   00   ││   00   ││   01  ║│
└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘└────────┘└───────╫┘
                                                                              ║
                  Here we steal one bit of storage from size to indicate mode ╝
```


### Small String V2
- `sizeof(T) == S`, `S >= 16`, `S % 8 == 0`
- `sso_size == S - 8 - sizeof(size_type)`
- not trivial to copy
- data always directly under the pointer
- check whether `small()` **NOT** always required.

#### Examples:
##### SSO
`▒ := data pointer`, `▓ := size`, `█ - payload`
```
            ┏┳━━━━━━━━━━━━━━━━━━━┓
 ┏━━━━━━━━━━┻┻━━━━━━━━━━━┓       ┃
┌00┬01┬02┬03┐┌04┬05┬06┬07┐┌08┬09┬0a┬0b┐┌0c┬0d┬0e┬0f┐
│▒▒│▒▒│▒▒│▒▒││▒▒│▒▒│▒▒│▒▒││▓▓│▓▓│██│██││██│██│██│00│
└──┴──┴──┴──┘└──┴──┴──┴──┘└──┴──┴──┴──┘└──┴──┴──┴──┘
```

##### Non-SSO
`▒ := data pointer`, `▓ := size`
```
            ┏┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━> far location
 ┏━━━━━━━━━━┻┻━━━━━━━━━━━┓
┌00┬01┬02┬03┐┌04┬05┬06┬07┐┌08┬09┬0a┬0b┐┌0c┬0d┬0e┬0f┐
│▒▒│▒▒│▒▒│▒▒││▒▒│▒▒│▒▒│▒▒││▓▓│▓▓│  │  ││  │  │  │  │
└──┴──┴──┴──┘└──┴──┴──┴──┘└──┴──┴──┴──┘└──┴──┴──┴──┘
```

